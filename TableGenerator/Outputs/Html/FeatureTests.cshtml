@using System.Linq
@using System.Text
@using System.Text.RegularExpressions
@inherits DependencyInjection.TableGenerator.Outputs.Html.HtmlTemplateBase<System.Collections.Generic.IEnumerable<DependencyInjection.TableGenerator.Data.FeatureTable>>

<!DOCTYPE html>
@* Metanote: Ignore the following note in Razor template, it is only relevant to the result. *@
<!-- Note: This file has been generated by TableGenerator and should not be edited manually. -->
<html>
  <head>
    <title>Dependency Injection Feature Tests (.NET)</title>
    <link rel='stylesheet' href='FeatureTests.css' />
  </head>
  <body>
    <div class="content">
      <h1>Dependency Injection Feature Tests (.NET)</h1>

      @foreach (var table in Model) {
      <section>
        <h2>@table.Name</h2>
        <div class="description">@table.Description</div>
        
        @{ var featuresWithDescription = table.Features.Where(f => !string.IsNullOrEmpty(f.Description)).ToArray(); }
        @if (featuresWithDescription.Any()) {
          <dl>
            @foreach (var feature in featuresWithDescription) {
              <dt>@feature.Name</dt>
              <dd>@feature.Description</dd>
            }
          </dl>
        }

        <table>
          <tr>
            <th>Framework</th>
            @foreach (var feature in table.Features) {
              <th>@feature.Name</th>
            }
          </tr>
          @{ var linkPrefix = Regex.Replace(table.Name, @"\W+", "-").ToLowerInvariant(); }
          @{ var comments = table.GetRows().SelectMany(r => r.Item2)
                                           .Where(c => c.HasComment)
                                           .Select(c => c.Comment)
                                           .GroupBy(c => c)
                                           .Select((g, index) => new { comment = g.Key, index = index + 1 })
                                           .ToList(); } 

          @foreach (var row in table.GetRows()) {
          <tr>
            <td>@row.Item1.FrameworkName</td>
            @foreach (var cell in row.Item2) {
              <td class="@(cell.State.ToString().ToLowerInvariant())">
              @if (cell.HasComment) {
                  var index = @comments.Single(x => x.comment == @cell.Comment).index;
                  <a class="local" href="#@linkPrefix-@index">@cell.Text<sup>@index</sup></a>
              }
              else if (cell.Exception != null) {
                  var exceptionStringBytes = Encoding.UTF8.GetBytes(cell.Exception.ToString());
                  <a href="data:text/plain;base64,@Convert.ToBase64String(exceptionStringBytes)">@cell.Text</a>
              }
              else {
                  @cell.Text
              }
              </td>
            }
          </tr>
          }
        </table>
        
        <ol>
        @foreach (var x in comments) {
          <li id="@linkPrefix-@x.index">@x.comment</li>
        }
        </ol>
      </section>
      }
    </div>
  </body>
</html>